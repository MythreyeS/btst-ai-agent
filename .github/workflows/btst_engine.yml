name: BTST AI Engine

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "run mode: btst / close / backtest"
        required: true
        default: "btst"
      lookback_days:
        description: "backtest lookback days (only for backtest)"
        required: false
        default: "60"

  schedule:
    # Weekdays 3:20 PM IST (9:50 UTC) -> generate BTST idea before close
    - cron: '50 9 * * 1-5'
    # Weekdays 9:25 AM IST (3:55 UTC) -> close yesterday trade (optional)
    - cron: '55 3 * * 1-5'

jobs:
  btst-engine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Decide Mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "MODE=${{ inputs.mode }}" >> $GITHUB_OUTPUT
            echo "LOOKBACK=${{ inputs.lookback_days }}" >> $GITHUB_OUTPUT
          else
            # schedule: 9:50 UTC -> btst, 3:55 UTC -> close
            NOW_HOUR=$(date -u +"%H")
            NOW_MIN=$(date -u +"%M")
            if [ "$NOW_HOUR" = "09" ] && [ "$NOW_MIN" = "50" ]; then
              echo "MODE=btst" >> $GITHUB_OUTPUT
              echo "LOOKBACK=60" >> $GITHUB_OUTPUT
            else
              echo "MODE=close" >> $GITHUB_OUTPUT
              echo "LOOKBACK=60" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run Engine
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python main.py ${{ steps.mode.outputs.MODE }} ${{ steps.mode.outputs.LOOKBACK }}

      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: btst-reports
          path: |
            data/trades.csv
            data/performance_weekly.csv
            data/weekly.json
            data/capital.json
          if-no-files-found: ignore
